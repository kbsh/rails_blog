<%#
+++
date = "2016-07-22T12:20:51Z"
draft = false
title = "SSHトンネル（ポートフォワード）の掘り方"
categories = ["linux"]
+++
%>

### 概要

```
Aサーバー( ローカル )　：　Bサーバーにアクセス可能、Cサーバーにアクセス不可
Bサーバー( 踏み台 )　　：　Cサーバーにアクセス可能
Cサーバー( リモート )　：　Bサーバー以外からのアクセスを拒否
```

ポートフォワードとは、上図において、ローカルからリモートに接続するために予め通り道を作ることを言う。

---

### 事前準備

1. ローカルにて鍵を作成

```
# ローカルサーバーに接続
$ mkdir ~/.ssh
$ chmod 700 ~/.ssh
$ cd ~/.ssh
$ ssh-keygen -N "" -t rsa
$ chmod 600 id_rsa id_rsa.pub
```

ssh-keygenの対話は全てエンターでOK


2. ローカルで作成した公開鍵を配置

踏み台、リモートサーバーにそれぞれ接続し、
ローカルサーバーで作成した`id_rsa.pub`を`~/.ssh/authorized_keys`に追加

※それぞれ、接続したいユーザーのホームディレクトリに配置すること

---

### トンネル開通

```
# ローカルサーバーに接続
ssh -L { 任意の転送ポート }:{ リモートのIPアドレス }:22 -i ~/.ssh/id_rsa { 踏み台のユーザー名( 鍵を登録したユーザー ) }@{ 踏み台のIPアドレス }
```

鍵を登録するか聞かれたらyesでOK

---

### リモートに接続

**トンネル開通したまま**で別プロセスを立ち上げる

```
# ローカルサーバーに接続
ssh -i ~/.ssh/id_rsa -p { 転送ポート( トンネル開通時のもの ) } { リモートのユーザー名( 鍵を登録したユーザー ) }@localhost
```

鍵を登録するか聞かれたらyesでOK

