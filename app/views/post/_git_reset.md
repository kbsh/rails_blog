<%#
+++
date = "2016-04-10:27:51Z"
draft = false
title = "[git] add, commit, pushを取り消す"
categories = ["git"]
+++
%>


### まとめ


###### git resetのオプション

```
--soft
  HEAD の位置を変更する

--mixed( デフォルト )
  HEAD の位置、インデックスを変更する

--hard
  HEADの位置、インデックス、ワーキングツリーを変更する。
```


###### HEAD、インデックス、ワーキングツリーとは

```
HEAD
  ( 作業中ブランチの )最新コミットの位置

インデックス
  コミットする際に情報の取得先となる場。コミットしたい変更点をaddするとインデックスに登録される。

ワーキングツリー
  作業ディレクトリ
```


### git add の取り消し


addされた際は、以下の変更が行われている。

1. ファイル書き換えにより、ワーキングツリーが変更
1. addにより変更点がインデックスに登録


addを取り消すには、

> addにより変更点がインデックスに登録

これを取り消すのが妥当と考えられる。

つまり、

`ワーキングツリーを変更せずに、インデックスをHEAD（最新のコミットバージョン）に揃えればよい`

そのため、--mixedオプションを使い、`HEADとインデックスをHEADに移動する`（実際にはHEADは動かないが）


```
$ git reset HEAD [ファイルパス]
```

オプションの`--mixed`がデフォルトなので省略している。

引数未指定で全ファイルを取り消しできる。



******************************************************


### git commit の取り消し


git commitした際は、以下の変更が行われている

1. ファイル書き換えにより、ワーキングツリーが変更
1. addにより変更点がインデックスに登録
1. commitにより、HEADが移動する

commitを取り消すには、

> addにより変更点がインデックスに登録
> commitにより、HEADが移動する

これを取り消すのが妥当と考えられる。

つまり、

`ワーキングツリーを変更せずに、インデックスとHEADをHEAD^（最新の一つ前のコミットバージョン）に揃えればよい`

そのため、まず--softオプションを使い、`HEADを一つ前のコミットバージョンに移動する`

これでaddされた状態になるので、前述のadd取り消しを行う。


```
$ git reset --soft HEAD^
$ git reset HEAD [ファイルパス]
```

HEAD^^で二つ前、HEAD^^^で三つ前・・・となる


************************************************


### git push の取り消し


git pushした際は、以下の変更が行われている

1. ファイル書き換えにより、ワーキングツリーが変更
1. addにより変更点がインデックスに登録
1. commitにより、HEADが移動する
1. pushにより、リモートブランチのHEADが移動する


pushを取り消すには、

> commitにより、HEADが移動する
> pushにより、リモートブランチのHEADが移動する

これを取り消すのが妥当と考えられる。

つまり、

一つ前のコミットバージョンから再度pushをすればよい。

そのため、まずcommitの取り消しを行い、HEADを一つ前に戻った状態で再度pushを行う。


```
$ git reset --soft HEAD^
$ git push --force-with-lease [ リポジトリ名 ] [ ブランチ名 ]
```

`--force-with-lease`オプションにより、他人のコミットがあった場合失敗する。

forceコミットは危険なので、gitに慣れていない人は使わないこと。

