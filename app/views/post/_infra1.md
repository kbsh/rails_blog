<%#
+++
date = "2016-05-13T15:44:51Z"
draft = false
title = "サーバー台数増減に関して"
categories = ["インフラ"]
+++
%>


下記のような、外部要因はいったん考慮外とします。

+ アプリ側の改修でスケールできないか
  + キャッシュの利用など
+ プロモーションやコスト削減など、負荷の増減が予想できないか



*********************


### 構成の前提

```
wwwサーバー、dbサーバーがある。<br>
wwwサーバーはロードバランサーによりスケールしている。<br>
dbサーバーはレプリケーションによりスケールしている。
```

dbサーバーのほうが、アクセスによる負荷の増減が大きいため注意すること<br>
また、wwwサーバーのほうがチューニングにより台数を絞りやすいのでしっかり設計すること。


********************


### 見たほうがよい指標

最大負荷がかかるときに計測すること。


+ **CPU使用率**
  + 30%～70%くらいが適正？
  + スケールアップの観点もあり、dbサーバーはwwwサーバーより少し余裕を見たほうがよい
+ **ロードアベレージ**（n秒あたりの実行待ちプロセス数）
  + cpuコア数を超えていないか
  + 1以上でも、コア数以内であれば問題なし
+ **iops**（秒毎のI/Oアクセス可能数）、**I/O wait**（I/O待ち時間の割合）
  + iopsに対し、I/O数に余裕があるか
  + 特にdbサーバーでみるべき指標
+ **メモリ**
  + freeが十分か
  + プロセスのメモリ使用量合計(RES)がどれほどか
+ さばけるリクエスト数（apache:MaxClients）
  + apache confで確認
  + メモリに余裕があり、プロセス数がMaxClientsより多ければ、MaxClientsを増やす
  + 特にwwwサーバーでみるべき指標

**************************


### 便利なコマンド、ツール

| なまえ | 説明 | 追記|
| --- | --- | --- |
| top | さまざまなモニタリング | 1押したらコアごとのも見れる |
| sar | 10分ごとのモニタリング | sysstatパッケージに入っている |





